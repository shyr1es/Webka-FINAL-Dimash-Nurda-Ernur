<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸŒ¤ï¸ Weather Analytics</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <button class="lang-switch" onclick="toggleLanguage()">ğŸŒ EN/RU</button>
  <h1 id="title">ğŸŒ¤ï¸ Weather Analytics</h1>

  <!-- ğŸ“ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ -->
  <div id="register-section">
    <h2 id="reg-title">ğŸ“ Register</h2>
    <input type="text" id="reg-username" placeholder="Username">
    <input type="password" id="reg-password" placeholder="Password">
    <button onclick="register()" id="reg-btn">Register</button>
    <p id="register-error" style="color: red;"></p>
    <p id="reg-login-link">
      Already have an account? <button class="link-btn" onclick="showLogin()">Login here</button>
    </p>
  </div>

  <!-- ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´ -->
  <div id="login-section">
    <h2 id="login-title">ğŸ”‘ Login</h2>
    <input type="text" id="login-username" placeholder="Username">
    <input type="password" id="login-password" placeholder="Password">
    <button onclick="login()" id="login-btn">Login</button>
    <p id="login-error" style="color: red;"></p>
    <p id="login-reg-link">
      Don't have an account? <button class="link-btn" onclick="showRegister()">Register here</button>
    </p>
  </div>

  <!-- ğŸŒ¦ï¸ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ñ‹ -->
  <div id="weather-section">
    <h2 id="weather-title">ğŸ“ˆ Weather Data</h2>
    <label for="city" id="city-label">ğŸŒ Enter City:</label>
    <input type="text" id="city">
    <label for="field" id="field-label">ğŸ“Š Select Field:</label>
    <select id="field">
      <option value="temperature">ğŸŒ¡ï¸ Temperature (Â°C)</option>
      <option value="humidity">ğŸ’§ Humidity (%)</option>
      <option value="wind_speed">ğŸŒ¬ï¸ Wind Speed (m/s)</option>
    </select>
    <button onclick="fetchWeather()" id="get-weather-btn">Get Weather</button>
    <button onclick="logout()" id="logout-btn" class="logout-btn">ğŸšª Logout</button>

    <div id="metrics">
      <h3 id="stats-title">ğŸ“Š Statistics</h3>
      <p id="avg"></p>
      <p id="min"></p>
      <p id="max"></p>
      <p id="stdDev"></p>
    </div>
    <canvas id="weatherChart"></canvas>
  </div>

  <script>
    let token = null;
    let language = "en";
    let chartInstance = null;

    window.onload = () => showRegister();

    function toggleLanguage() {
      language = language === "en" ? "ru" : "en";
      updateLanguage();
    }

    function updateLanguage() {
      if (language === "ru") {
        document.getElementById("title").innerText = "ğŸŒ¤ï¸ ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° ĞŸĞ¾Ğ³Ğ¾Ğ´Ñ‹";
        document.getElementById("reg-title").innerText = "ğŸ“ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ";
        document.getElementById("reg-btn").innerText = "Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ";
        document.getElementById("reg-login-link").innerHTML =
          'Ğ£Ğ¶Ğµ ĞµÑÑ‚ÑŒ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚? <button class="link-btn" onclick="showLogin()">Ğ’Ğ¾Ğ¹Ñ‚Ğ¸</button>';
        document.getElementById("login-title").innerText = "ğŸ”‘ Ğ’Ñ…Ğ¾Ğ´";
        document.getElementById("login-btn").innerText = "Ğ’Ğ¾Ğ¹Ñ‚Ğ¸";
        document.getElementById("login-reg-link").innerHTML =
          'ĞĞµÑ‚ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğ°? <button class="link-btn" onclick="showRegister()">Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ</button>';
        document.getElementById("weather-title").innerText = "ğŸ“ˆ Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾ Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğµ";
        document.getElementById("city-label").innerText = "ğŸŒ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´:";
        document.getElementById("field-label").innerText = "ğŸ“Š Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€:";
        document.getElementById("get-weather-btn").innerText = "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ";
        document.getElementById("logout-btn").innerText = "ğŸšª Ğ’Ñ‹Ñ…Ğ¾Ğ´";
        document.getElementById("stats-title").innerText = "ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°";
      } else {
        document.getElementById("title").innerText = "ğŸŒ¤ï¸ Weather Analytics";
        document.getElementById("reg-title").innerText = "ğŸ“ Register";
        document.getElementById("reg-btn").innerText = "Register";
        document.getElementById("reg-login-link").innerHTML =
          'Already have an account? <button class="link-btn" onclick="showLogin()">Login here</button>';
        document.getElementById("login-title").innerText = "ğŸ”‘ Login";
        document.getElementById("login-btn").innerText = "Login";
        document.getElementById("login-reg-link").innerHTML =
          'Don\'t have an account? <button class="link-btn" onclick="showRegister()">Register here</button>';
        document.getElementById("weather-title").innerText = "ğŸ“ˆ Weather Data";
        document.getElementById("city-label").innerText = "ğŸŒ Enter City:";
        document.getElementById("field-label").innerText = "ğŸ“Š Select Field:";
        document.getElementById("get-weather-btn").innerText = "Get Weather";
        document.getElementById("logout-btn").innerText = "ğŸšª Logout";
        document.getElementById("stats-title").innerText = "ğŸ“Š Statistics";
      }
    }

    function showRegister() {
      document.getElementById("register-section").style.display = "block";
      document.getElementById("login-section").style.display = "none";
      document.getElementById("weather-section").style.display = "none";
      updateLanguage();
    }

    function showLogin() {
      document.getElementById("register-section").style.display = "none";
      document.getElementById("login-section").style.display = "block";
      document.getElementById("weather-section").style.display = "none";
      updateLanguage();
    }

    function logout() {
      token = null;
      showLogin();
    }

    async function register() {
      const username = document.getElementById("reg-username").value;
      const password = document.getElementById("reg-password").value;
      const response = await fetch("http://localhost:5000/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (response.ok) {
        alert(language === "ru" ? "âœ… Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ ÑƒÑĞ¿ĞµÑˆĞ½Ğ°! Ğ’Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ñƒ." : "âœ… Registration successful! Please log in.");
        showLogin();
      } else {
        document.getElementById("register-error").textContent = `âŒ ${data.error}`;
      }
    }

    async function login() {
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;
      const response = await fetch("http://localhost:5000/api/auth/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password })
      });
      const data = await response.json();
      if (response.ok) {
        token = data.token;
        document.getElementById("login-section").style.display = "none";
        document.getElementById("weather-section").style.display = "block";
      } else {
        document.getElementById("login-error").textContent = `âŒ ${data.error}`;
      }
    }

    async function fetchWeather() {
      const city = document.getElementById("city").value;
      const field = document.getElementById("field").value;
      if (!city) {
        return alert(language === "ru" ? "âš ï¸ Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ³Ğ¾Ñ€Ğ¾Ğ´Ğ°!" : "âš ï¸ Enter a city name!");
      }

      const weatherResponse = await fetch(`http://localhost:5000/api/weather?city=${city}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const weatherData = await weatherResponse.json();
      if (!weatherResponse.ok) return alert(`âŒ ${weatherData.error}`);

      const statsResponse = await fetch(`http://localhost:5000/api/weather/metrics?city=${city}&field=${field}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const stats = await statsResponse.json();
      document.getElementById("avg").textContent = `${language === "ru" ? "Ğ¡Ñ€ĞµĞ´Ğ½ĞµĞµ" : "Average"}: ${stats.avg}`;
      document.getElementById("min").textContent = `${language === "ru" ? "ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼" : "Min"}: ${stats.min}`;
      document.getElementById("max").textContent = `${language === "ru" ? "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼" : "Max"}: ${stats.max}`;
      document.getElementById("stdDev").textContent = `${language === "ru" ? "Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğµ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸Ğµ" : "Std Dev"}: ${stats.stdDev}`;

      const historyResponse = await fetch(`http://localhost:5000/api/weather/history?city=${city}&field=${field}`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      const historyData = await historyResponse.json();
      const timestamps = historyData.map(item => new Date(item.timestamp).toLocaleString());
      const values = historyData.map(item => item[field]);
      renderChart(timestamps, values, `${field} ${language === "ru" ? "Ğ´Ğ»Ñ" : "in"} ${city}`);
    }

    function renderChart(labels, data, label) {
      const ctx = document.getElementById("weatherChart").getContext("2d");
      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: { labels, datasets: [{ label, data, borderColor: "blue", borderWidth: 2 }] },
        options: { responsive: true }
      });
    }
  </script>
</body>
</html>
